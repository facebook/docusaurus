---
sidebar_position: 9
slug: /api/plugins/@docusaurus/plugin-pwa
---

# üì¶ plugin-pwa

Plugin Docusaurus pour ajouter le support PWA en utilisant [Workbox](https://developers.google.com/web/tools/workbox). Ce plugin g√©n√®re un [Service Worker](https://developers.google.com/web/fundamentals/primers/service-workers) uniquement en production, et vous permet de cr√©er un site de documentation enti√®rement conforme √† la PWA avec support du mode hors ligne et de l'installation.

## Installation {#installation}

```bash npm2yarn
npm install --save @docusaurus/plugin-pwa
```

## Configuration {#configuration}

Cr√©ez un [manifeste PWA](https://web.dev/add-manifest/) dans `./static/manifest.json`.

Modifiez `docusaurus.config.js` avec une configuration PWA minimale, tel que :

```js title="docusaurus.config.js"
export default {
  plugins: [
    [
      '@docusaurus/plugin-pwa',
      {
        debug: true,
        offlineModeActivationStrategies: [
          'appInstalled',
          'standalone',
          'queryString',
        ],
        pwaHead: [
          {
            tagName: 'link',
            rel: 'icon',
            href: '/img/docusaurus.png',
          },
          {
            tagName: 'link',
            rel: 'manifest',
            href: '/manifest.json', // votre manifest PWA
          },
          {
            tagName: 'meta',
            name: 'theme-color',
            content: 'rgb(37, 194, 160)',
          },
        ],
      },
    ],
  ],
};
```

## Application Web progressive {#progressive-web-app}

L'installation d'un Service Worker ne suffit pas √† faire de votre application une PWA. Vous devez inclure au moins un [Manifeste d'Application Web](https://developer.mozilla.org/en-US/docs/Web/Manifest) et avoir les tags corrects dans le `<head>` ([Options > pwaHead](#pwahead)).

Apr√®s le d√©ploiement, vous pouvez utiliser [Lighthouse](https://developers.google.com/web/tools/lighthouse) pour ex√©cuter un audit sur votre site.

Pour une liste plus exhaustive de ce qu'il faut pour que votre site soit un PWA, reportez-vous √† la [Liste de contr√¥le PWA](https://developers.google.com/web/progressive-web-apps/checklist)

## Prise en charge de l'installation de l'application {#app-installation-support}

Si votre navigateur le supporte, vous devriez pouvoir installer un site Docusaurus en tant qu'application.

![Un extrait d'√©cran du processus d'installation. Un bouton appara√Æt dans la barre d'adresse du navigateur, qui affiche une bo√Æte de dialogue demandant "install this application?" lorsqu'il est cliqu√©. Apr√®s avoir cliqu√© sur le bouton "Instal", une nouvelle application est ouverte dans le syst√®me d'exploitation, s'ouvrant sur la page d'accueil de Docusaurus.](/img/pwa_install.gif)

:::note

L'installation de l'application n√©cessite le protocole HTTPS et un manifeste valide.

:::

## Mode hors ligne (pr√©-cache) {#offline-mode-precaching}

Il est possible de permettre aux utilisateurs de naviguer sur un site Docusaurus hors ligne gr√¢ce au pr√©-cache du service-worker.

La page [workbox-precaching](https://developers.google.com/web/tools/workbox/modules/workbox-precaching) explique l'id√©e¬†:

> Une des caract√©ristiques des services workers est la possibilit√© d'enregistrer un ensemble de fichiers dans le cache lors de l'installation du service worker. On l'appelle souvent ¬´¬†pr√©-cache¬†¬ª, puisque vous mettez en cache du contenu avant que le service ne soit utilis√©.
>
> La principale raison de ce choix est qu'il donne aux d√©veloppeurs le contr√¥le du cache, ce qui signifie qu'ils peuvent d√©terminer quand et combien de temps un fichier est mis en cache et le servir au navigateur sans passer par le r√©seau, ce qui signifie qu'il peut √™tre utilis√© pour cr√©er des applications web qui fonctionnent hors ligne.
>
> Workbox se charge d'une grande partie de la mise en cache en simplifiant l'API et en garantissant un t√©l√©chargement efficace des ressources.

Par d√©faut, le mode hors ligne est activ√© lorsque le site est install√© en tant qu'application. Voir l'option `offlineModeActivationStrategies` pour plus de d√©tails.

Une fois que le site a √©t√© mis en pr√©cache, le service worker servira des r√©ponses en cache pour des visites ult√©rieures. Lorsqu'une nouvelle version est d√©ploy√©e avec un nouveau service worker, le nouveau commence √† s'installer et passe ensuite √† l'√©tat d'attente. Pendant cet √©tat d'attente, une popup de rechargement s'affichera et demandera √† l'utilisateur de recharger la page pour un nouveau contenu. Tant que l'utilisateur n'aura pas vid√© le cache de l'application ou cliqu√© sur le bouton `reload` de la popup, le service worker continuera √† servir l'ancien contenu.

:::warning

Le mode hors-ligne / pr√©-cache n√©cessite de t√©l√©charger tous les ressources statiques du site √† l'avance, et peut consommer de la bande passante inutilement. Ce n'est peut-√™tre pas une bonne id√©e de l'activer pour tous les types de sites.

:::

## Options {#options}

### `debug` {#debug}

- Type¬†: `boolean`
- Par d√©faut¬†: `false`

Permet d'activer le mode d√©bogage :

- Logs de Workbox
- Logs additionnels de Docusaurus
- Sortie de fichier SW non optimis√©
- Source maps

### `offlineModeActivationStrategies` {#offlinemodeactivationstrategies}

- Type¬†: `('appInstalled' | 'mobile' | 'saveData'| 'queryString' | 'always')[]`
- Par d√©faut : `['appInstalled', 'queryString', 'standalone']`

Strat√©gies utilis√©es pour activer le mode hors ligne :

- `appInstalled` : active pour les utilisateurs ayant install√© le site comme une application (pas fiable √† 100%)
- `standalone`¬†: active pour les utilisateurs ex√©cutant l'application comme autonome (souvent le cas une fois qu'une PWA est install√©)
- `queryString`¬†: active si queryString contient `offlineMode=true` (pratique pour le d√©bogage PWA)
- `mobile`¬†: active pour les utilisateurs mobiles (`width = 996px`)
- `saveData`¬†: active pour les utilisateurs avec `navigator.connection.saveData === true`
- `always`¬†: active pour tous les utilisateurs

:::warning

Utilisez ceci avec pr√©caution : certains utilisateurs n'aiment pas √™tre forc√©s d'utiliser le mode hors ligne.

:::

:::danger

Il n'est pas possible de d√©tecter de mani√®re fiable si une page est rendue comme une PWA.

L'√©v√©nement `appinstalled` a √©t√© [supprim√© de la sp√©cification](https://github.com/w3c/manifest/pull/836) et l'API [`navigator.getInstalledRelatedApps()`](https://web.dev/get-installed-related-apps/) n'est prise en charge que dans les versions r√©centes de Chrome et n√©cessite `related_applications` d√©clar√©e dans le manifeste.

La [strat√©gie `standalone`](https://petelepage.com/blog/2019/07/is-my-pwa-installed/) est une belle solution de secours pour activer le mode hors ligne (au moins lors de l'ex√©cution de l'application install√©e).

:::

### `injectManifestConfig` {#injectmanifestconfig}

Les [options de Workbox](https://developer.chrome.com/docs/workbox/reference/workbox-build/#type-InjectManifestOptions) √† passer √† `workbox.injectManifest()`. Cela vous permet de contr√¥ler les ressources qui seront mises en pr√©-cache et seront disponibles hors ligne.

- Type¬†: `InjectManifestOptions`
- Par d√©faut¬†: `{}`

```js title="docusaurus.config.js"
export default {
  plugins: [
    [
      '@docusaurus/plugin-pwa',
      {
        injectManifestConfig: {
          manifestTransforms: [
            //...
          ],
          modifyURLPrefix: {
            //...
          },
          // Nous ajoutons d√©j√† des √©l√©ments statiques r√©guliers (HTML, images...) pour qu'ils soient disponibles hors ligne.
          // Vous pouvez ajouter d'autres fichiers en fonction de vos besoins
          globPatterns: ['**/*.{pdf,docx,xlsx}'],
          // ...
        },
      },
    ],
  ],
};
```

### `pwaHead` {#pwahead}

- Type¬†: `({ tagName: string; [attributeName: string]: string })[]`
- Par d√©faut¬†: `[]`

Tableau d'objets contenant `tagName` et des paires cl√©-valeur pour les attributs √† injecter dans la balise `<head>`. Techniquement, vous pouvez injecter n'importe quelle balise head par ce biais, mais l'id√©al est de l'utiliser pour les balises afin de rendre votre site conforme √† la norme PWA. Voici une liste de tags pour rendre votre application enti√®rement compatible :

```js
export default {
  plugins: [
    [
      '@docusaurus/plugin-pwa',
      {
        pwaHead: [
          {
            tagName: 'link',
            rel: 'icon',
            href: '/img/docusaurus.png',
          },
          {
            tagName: 'link',
            rel: 'manifest',
            href: '/manifest.json',
          },
          {
            tagName: 'meta',
            name: 'theme-color',
            content: 'rgb(37, 194, 160)',
          },
          {
            tagName: 'meta',
            name: 'apple-mobile-web-app-capable',
            content: 'yes',
          },
          {
            tagName: 'meta',
            name: 'apple-mobile-web-app-status-bar-style',
            content: '#000',
          },
          {
            tagName: 'link',
            rel: 'apple-touch-icon',
            href: '/img/docusaurus.png',
          },
          {
            tagName: 'link',
            rel: 'mask-icon',
            href: '/img/docusaurus.svg',
            color: 'rgb(37, 194, 160)',
          },
          {
            tagName: 'meta',
            name: 'msapplication-TileImage',
            content: '/img/docusaurus.png',
          },
          {
            tagName: 'meta',
            name: 'msapplication-TileColor',
            content: '#000',
          },
        ],
      },
    ],
  ],
};
```

### `swCustom` {#swcustom}

- Type¬†: `string | undefined`
- Par d√©faut¬†: `undefined`

Utile pour des r√®gles additionnelles de Workbox. Vous pouvez faire tout ce qu'un service worker peut faire ici, et utiliser toute la puissance des biblioth√®ques Workbox. Le code est transpil√©, vous pouvez donc utiliser la syntaxe moderne ES6+ ici.

Par exemple, pour mettre en cache des fichiers depuis des chemins externes :

```js
import {registerRoute} from 'workbox-routing';
import {StaleWhileRevalidate} from 'workbox-strategies';

// default fn export re√ßoit quelques param√®tres utiles
export default function swCustom(params) {
  const {
    debug, // :boolean
    offlineMode, // :boolean
  } = params;

  // Mettre en cache les r√©ponses des ressources externes
  registerRoute((context) => {
    return [
      /graph\.facebook\.com\/.*\/picture/,
      /netlify\.com\/img/,
      /avatars1\.githubusercontent/,
    ].some((regex) => context.url.href.match(regex));
  }, new StaleWhileRevalidate());
}
```

Le module doit avoir une fonction d'exportation `default`, et re√ßoit quelques param√®tres.

### `swRegister` {#swregister}

- Type¬†: `string | false`
- Par d√©faut : `'docusaurus-plugin-pwa/src/registerSW.js'`

Ajoute une entr√©e avant l'application Docusaurus pour que l'enregistrement puisse se faire avant l'ex√©cution de l'application. Le fichier `registerSW.js` par d√©faut est suffisant pour un simple enregistrement.

Passer √† `false` d√©sactivera compl√®tement l'inscription.

## Exemple de manifeste {#manifest-example}

Le manifeste du site Docusaurus peut servir d'inspiration :

```mdx-code-block
import CodeBlock from '@theme/CodeBlock';

<CodeBlock className="language-json">
  {JSON.stringify(require('@site/static/manifest.json'),null,2)}
</CodeBlock>
```

## Personnalisation de la popup de rechargement {#customizing-reload-popup}

Le composant `@theme/PwaReloadPopup` est rendu lorsqu'un nouveau service worker attend d'√™tre install√©, et nous sugg√©rons un rechargement pour l'utilisateur. Vous pouvez [swizzler](../../swizzling.mdx) ce composant et impl√©menter votre propre interface utilisateur. Il recevra un callback `onReload` comme props, qui devrait √™tre appel√© lorsque le bouton `reload` est cliqu√©. Cela indiquera au service worker d'installer le service worker en attente et de recharger la page.

Le th√®me par d√©faut inclut une impl√©mentation pour la popup de rechargement et utilise [Infima Alerts](https://infima.dev/docs/components/alert).

![Un extrait d'√©cran du processus de rechargement. Une bo√Æte d'alerte appara√Æt en bas √† droite de la fen√™tre, en disant "Nouveau contenu disponible". Apr√®s avoir cliqu√© sur le bouton "Actualiser", le titre principal de la page passe de "Introduction" √† "PWA :))".](/img/pwa_reload.gif)

Votre composant peut rendre `null`, mais cela n'est pas recommand√© : les utilisateurs n'auront aucun moyen d'obtenir un contenu √† jour.
