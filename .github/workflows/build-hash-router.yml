name: Build Hash Router

on:
  push:
    branches: [main]
  pull_request:
    branches:
      - main
      - docusaurus-v**
    paths:
      - packages/**
      - .github/workflows/build-hash-router.yml

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

permissions:
  contents: write

jobs:
  build:
    name: Build Hash Router
    timeout-minutes: 30
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
      - name: Set up Node
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version: lts/*
          cache: yarn
      - name: Installation
        run: yarn || yarn || yarn

      - name: Build Hash Router
        run: yarn build:website:fast
        env:
          DOCUSAURUS_PERF_LOGGER: 'true'
          DOCUSAURUS_ROUTER: 'hash'
          # Note: hash router + baseUrl do not play well together
          # This would host at https://facebook.github.io/docusaurus/#/docusaurus/
          # BASE_URL: '/docusaurus/' # hash router +

      - name: Upload Website artifact
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: website-hash-router-archive
          path: website/build

      #- name: Upload Website Pages artifact
      #  uses: actions/upload-pages-artifact@7b1f4a764d45c48632c6b24a0339c27f5614fb0b # v4.0.0
      #  with:
      #    path: website/build

      # Deploy to https://facebook.github.io/docusaurus/
      - name: Deploy to GitHub Pages
        if: ${{ github.event_name != 'pull_request' && github.ref_name == 'main' }}
        uses: peaceiris/actions-gh-pages@4f9cc6602d3f66b9c108549d475ec49e8ef4d45e # v4.0.0
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: website/build

  ## TODO we should be able to use this new deploy-pages action
  ## However this requires a Meta admin to configure it here
  ## https://github.com/facebook/docusaurus/settings/pages
  ## So for now we keep using the former method
  ## See https://docusaurus.io/docs/deployment#triggering-deployment-with-github-actions
  #deploy:
  #  name: Deploy to GitHub Pages
  #  if: ${{ github.event_name != 'pull_request' && github.ref_name == 'main' }}
  #  needs: build
  #  permissions:
  #    pages: write
  #    id-token: write
  #  environment:
  #    name: github-pages
  #    url: ${{ steps.deployment.outputs.page_url }}
  #  runs-on: ubuntu-latest
  #  steps:
  #     - name: Deploy to GitHub Pages
  #      id: deployment
  #      uses: actions/deploy-pages@d6db90164ac5ed86f2b6aed7e0febac5b3c0c03e # v4.0.5
